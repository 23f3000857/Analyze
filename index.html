<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Repo Files: execute.py fix, data.csv, and CI workflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; line-height: 1.5; }
    header { padding: 16px 20px; background: #0d1117; color: #e6edf3; }
    h1 { margin: 0 0 4px 0; font-size: 20px; }
    .wrap { padding: 18px 20px; max-width: 1100px; margin: 0 auto; }
    .note { background: rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.1); padding: 12px 14px; border-radius: 8px; }
    .files { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; margin-top: 16px; }
    .card { border: 1px solid rgba(0,0,0,.12); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
    .card header { background: #f6f8fa; color: #1f2328; padding: 10px 12px; font-weight: 600; font-size: 14px; border-bottom: 1px solid rgba(0,0,0,.06); }
    .card pre { margin: 0; padding: 12px; overflow: auto; max-height: 340px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12.5px; }
    .actions { display: flex; gap: 8px; padding: 12px; border-top: 1px solid rgba(0,0,0,.06); background: #fafbfc; }
    button { border: 1px solid rgba(0,0,0,.2); background: white; padding: 6px 10px; border-radius: 7px; cursor: pointer; font-size: 13px; }
    button:hover { background: #f3f4f6; }
    .ok { color: #0a7f2e; font-weight: 600; }
    code.filename { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f6f8fa; padding: 1px 6px; border-radius: 6px; }
    footer { padding: 24px 20px; color: #57606a; font-size: 12.5px; }
  </style>
</head>
<body>
<header>
  <h1>Fix execute.py, add data.csv, and CI Pages publish</h1>
  <div>This page contains the repository files to create/commit.</div>
</header>

<div class="wrap">
  <div class="note">
    - Commit the files shown below as-is.<br>
    - Do not commit result.json; it will be generated by CI and published to GitHub Pages.<br>
    - The workflow runs ruff, executes <code class="filename">python execute.py &gt; result.json</code>, and deploys result.json.
  </div>

  <div class="files" id="files"></div>
</div>

<footer class="wrap">
  Tips:
  - Copy each file content and save to the indicated path in your repo.
  - Ensure the folder .github/workflows exists before adding ci.yml.
</footer>

<template data-filename="execute.py" data-path="execute.py" data-language="python">
import json
import os
from typing import Any, Dict, List

import pandas as pd


def load_data(path_xlsx: str = "data.xlsx", path_csv: str = "data.csv") -> pd.DataFrame:
    """
    Load transactional data from CSV if present, otherwise from XLSX.

    Requirements:
    - Python 3.11+
    - pandas 2.3+
    - openpyxl (only if reading .xlsx)
    """
    if os.path.exists(path_csv):
        df = pd.read_csv(path_csv)
    elif os.path.exists(path_xlsx):
        # openpyxl is required by pandas 2.3 to read .xlsx files
        df = pd.read_excel(path_xlsx, engine="openpyxl")
    else:
        raise FileNotFoundError(
            f"Neither {path_csv} nor {path_xlsx} was found in the working directory."
        )

    # Ensure dtypes are usable downstream
    if "date" in df.columns:
        df["date"] = pd.to_datetime(df["date"])
    for col in ("units", "price"):
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors="coerce").fillna(0)

    return df


def compute_summary(df: pd.DataFrame, n: int = 3) -> Dict[str, Any]:
    # Compute revenue
    df = df.copy()
    if "revenue" not in df.columns:
        if not {"units", "price"} <= set(df.columns):
            raise KeyError("Input must contain 'units' and 'price' columns.")
        df["revenue"] = df["units"] * df["price"]

    # row_count
    row_count = int(len(df))

    # regions: count of distinct regions
    if "region" not in df.columns:
        raise KeyError("Input must contain 'region' column.")
    regions_count = int(df["region"].nunique())

    # top_n_products_by_revenue (n=3)
    if "product" not in df.columns:
        raise KeyError("Input must contain 'product' column.")
    top_products = (
        df.groupby("product", as_index=False)["revenue"]
        .sum()
        .sort_values("revenue", ascending=False)
        .head(n)
        .reset_index(drop=True)
    )
    top_products_list: List[Dict[str, Any]] = [
        {"product": str(row["product"]), "revenue": float(row["revenue"])}
        for _, row in top_products.iterrows()
    ]

    # rolling_7d_revenue_by_region:
    # For each region, compute the last value of the 7-day moving average of daily revenue
    if "date" not in df.columns:
        raise KeyError("Input must contain 'date' column.")
    df["date"] = pd.to_datetime(df["date"])
    daily_rev = (
        df.groupby(["region", "date"], as_index=False)["revenue"]
        .sum()
        .sort_values(["region", "date"])
    )
    # 7-day rolling mean per region
    daily_rev["rolling_7d"] = (
        daily_rev.groupby("region", group_keys=False)["revenue"]
        .rolling(window=7, min_periods=1)
        .mean()
        .reset_index(level=0, drop=True)
    )
    last_ma = (
        daily_rev.groupby("region", as_index=False)["rolling_7d"]
        .last()
        .rename(columns={"rolling_7d": "rolling_7d_revenue"})
    )
    rolling_list: List[Dict[str, Any]] = [
        {"region": str(r["region"]), "rolling_7d_revenue": float(r["rolling_7d_revenue"])}
        for _, r in last_ma.iterrows()
    ]

    return {
        "row_count": row_count,
        "regions_count": regions_count,
        "top_n_products_by_revenue": top_products_list,
        "rolling_7d_revenue_by_region": rolling_list,
    }


def main() -> None:
    df = load_data()
    summary = compute_summary(df)
    print(json.dumps(summary, indent=2))


if __name__ == "__main__":
    main()
</template>

<template data-filename="GitHub Actions Workflow" data-path=".github/workflows/ci.yml" data-language="yaml">
name: CI

on:
  push:
    branches:
      - "**"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "pandas>=2.3,<2.4" openpyxl ruff

      - name: Ruff (lint)
        run: |
          ruff --version
          ruff check .

      - name: Run execute.py to produce result.json
        run: |
          python execute.py > result.json
          test -s result.json

      - name: Prepare GitHub Pages artifact
        run: |
          mkdir -p public
          # Publish the result and a simple index page
          cp result.json public/result.json
          # Reuse project index.html if present; otherwise create a basic one
          if [ -f "index.html" ]; then
            cp index.html public/index.html
          else
            cat > public/index.html <<'HTML'
            <!doctype html>
            <meta charset="utf-8">
            <title>Result</title>
            <pre id="out"></pre>
            <script>
              fetch('result.json').then(r=>r.json()).then(j=>{
                document.getElementById('out').textContent = JSON.stringify(j, null, 2);
              });
            </script>
HTML
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
</template>

<template data-filename="Git ignore" data-path=".gitignore" data-language="text">
# Do not commit CI outputs
result.json
public/
</template>

<template data-filename="CSV (converted from data.xlsx; commit this file)" data-path="data.csv" data-language="csv">
__CSV_WILL_BE_FILLED_WITH_CONTENT_CONVERTED_FROM_data.xlsx__
</template>

<script>
(function () {
  const container = document.getElementById('files');
  const templates = Array.from(document.querySelectorAll('template[data-path]'));

  function makeCard(tpl) {
    const path = tpl.dataset.path;
    const language = tpl.dataset.language || 'text';
    const title = tpl.dataset.filename || path;
    const content = tpl.innerHTML
      .replace(/^\n/, '')
      .replace(/\s+$/, '');

    const card = document.createElement('div');
    card.className = 'card';

    const head = document.createElement('header');
    head.textContent = path;
    card.appendChild(head);

    const pre = document.createElement('pre');
    pre.dataset.path = path;
    pre.dataset.language = language;
    pre.textContent = content;
    card.appendChild(pre);

    const actions = document.createElement('div');
    actions.className = 'actions';

    const copyBtn = document.createElement('button');
    copyBtn.textContent = 'Copy';
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(content);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => (copyBtn.textContent = 'Copy'), 1200);
      } catch {
        alert('Copy failed. Select and copy manually.');
      }
    });
    actions.appendChild(copyBtn);

    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'Download';
    saveBtn.addEventListener('click', () => {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = path.split('/').pop();
      a.click();
      URL.revokeObjectURL(a.href);
    });
    actions.appendChild(saveBtn);

    card.appendChild(actions);
    return card;
  }

  templates.forEach(t => container.appendChild(makeCard(t)));
})();
</script>
</body>
</html>